const { Client, LocalAuth } = require('whatsapp-web.js');
const qrcode = require('qrcode-terminal');
const axios = require('axios');
const express = require('express');

const app = express();
const PORT = process.env.PORT || 3000;

// Configura√ß√£o do WhatsApp
const client = new Client({
    authStrategy: new LocalAuth({
        clientId: "vex-bot"
    }),
    puppeteer: {
        args: ['--no-sandbox', '--disable-setuid-sandbox'],
        headless: true
    }
});

// Configura√ß√£o da API DeepSeek
const DEEPSEEK_API_KEY = process.env.DEEPSEEK_API_KEY;
const DEEPSEEK_URL = 'https://api.deepseek.com/v1/chat/completions';

// Banco de dados em mem√≥ria
let groupData = {};
let authorizedGroups = new Set();

// ‚úÖ SERVIDOR WEB PARA O RENDER
app.use(express.json());

app.get('/', (req, res) => {
    res.json({ 
        status: 'online',
        bot: 'Vex',
        message: 'Bot WhatsApp est√° funcionando!'
    });
});

app.get('/health', (req, res) => {
    res.json({ 
        status: 'healthy',
        timestamp: new Date().toISOString(),
        authorizedGroups: authorizedGroups.size
    });
});

app.listen(PORT, () => {
    console.log(`üåê Servidor web rodando na porta ${PORT}`);
});

// EVENTOS DO WHATSAPP
client.on('qr', (qr) => {
    console.log('üì± QR Code para conex√£o:');
    qrcode.generate(qr, {small: true});
    console.log('üí° Escaneie este QR code no WhatsApp');
});

client.on('ready', () => {
    console.log('‚úÖ Vex Bot com IA conectado!');
    console.log('üß† Usando DeepSeek para categoriza√ß√£o inteligente');
    console.log('üîí Vex s√≥ responder√° em grupos autorizados com "/adicionar vex"');
    console.log(`üåê Servidor health: http://localhost:${PORT}/health`);
});

client.on('message', async (message) => {
    if (message.from === 'status@broadcast' || message.from === 'broadcast') return;
    if (message.type === 'broadcast') return;
    
    try {
        const response = await processVexMessage(message);
        if (response) {
            message.reply(response);
        }
    } catch (error) {
        console.error('Erro:', error);
    }
});

// üî• ADICIONE ESTA PARTE CR√çTICA PARA EVITAR MEM√ìRIA
client.on('disconnected', (reason) => {
    console.log('‚ùå Bot desconectado:', reason);
    console.log('üîÑ Reiniciando em 5 segundos...');
    setTimeout(() => {
        client.initialize();
    }, 5000);
});

// FUN√á√ÉO PRINCIPAL DO VEX (MANTENHA TODO O C√ìDIGO ANTERIOR AQUI)
async function processVexMessage(message) {
    const groupId = message.from;
    const userMessage = message.body.trim();
    const isGroup = groupId.includes('@g.us');
    
    if (!userMessage) return null;
    
    console.log(`üí¨ Mensagem de ${getSenderName(message)}: ${userMessage}`);

    // Comando para adicionar Vex ao grupo
    if (userMessage.toLowerCase() === '/adicionar vex') {
        authorizedGroups.add(groupId);
        console.log(`‚úÖ Vex autorizado no grupo: ${groupId}`);
        return `ü§ñ *Vex ativado!* 
        
Agora estou pronto para ajudar neste grupo! 

*Comandos dispon√≠veis:*
üé¨ Entretenimento: Envie nomes de filmes/s√©ries
üí∞ Gastos: "descri√ß√£o valor" (ex: uber 25)
üõí Compras: "itens" (ex: leite, p√£o, ovos)

*Comandos especiais:*
!ajuda - Mostra ajuda completa
!status - Status das listas
!limpar - Limpa todos os dados
!vexinfo - Informa√ß√µes do Vex`;
    }

    // Se n√£o for grupo ou grupo n√£o autorizado, ignorar
    if (!isGroup || !authorizedGroups.has(groupId)) {
        return null;
    }

    // Inicializar grupo se n√£o existir
    if (!groupData[groupId]) {
        groupData[groupId] = await detectGroupTypeWithAI(userMessage);
    }
    
    const groupType = groupData[groupId].type;
    
    // Comandos especiais do Vex
    if (userMessage.toLowerCase() === '!ajuda') {
        return getVexHelpMessage(groupType);
    }
    
    if (userMessage.toLowerCase() === '!limpar') {
        return clearGroupData(groupId);
    }
    
    if (userMessage.toLowerCase() === '!status') {
        return getGroupStatus(groupId, groupType);
    }
    
    if (userMessage.toLowerCase() === '!vexinfo') {
        return getVexInfo(groupId);
    }

    // Se for comando de remover Vex
    if (userMessage.toLowerCase() === '/remover vex') {
        authorizedGroups.delete(groupId);
        return 'ü§ñ Vex removido deste grupo. Use "/adicionar vex" para me ativar novamente.';
    }

    // Processamento com IA para grupos autorizados
    switch(groupType) {
        case 'entretenimento':
            return await processEntertainmentItemWithAI(userMessage, groupId);
        case 'gastos':
            return await processExpenseItemWithAI(userMessage, groupId);
        case 'compras':
            return await processShoppingItemWithAI(userMessage, groupId);
        default:
            return await processEntertainmentItemWithAI(userMessage, groupId);
    }
}

// üß† FUN√á√ÉO PRINCIPAL DE IA
async function callDeepSeekAI(prompt, systemMessage = "Voc√™ √© um assistente √∫til.") {
    if (!DEEPSEEK_API_KEY) {
        console.log('‚ö†Ô∏è API Key do DeepSeek n√£o configurada');
        throw new Error('API Key do DeepSeek n√£o configurada');
    }
    
    try {
        const response = await axios.post(DEEPSEEK_URL, {
            model: 'deepseek-chat',
            messages: [
                { role: 'system', content: systemMessage },
                { role: 'user', content: prompt }
            ],
            max_tokens: 500,
            temperature: 0.3
        }, {
            headers: {
                'Authorization': `Bearer ${DEEPSEEK_API_KEY}`,
                'Content-Type': 'application/json'
            },
            timeout: 10000
        });

        return response.data.choices[0].message.content.trim();
    } catch (error) {
        console.error('Erro na API DeepSeek:', error.response?.data || error.message);
        throw new Error('Falha na comunica√ß√£o com IA');
    }
}

// üéØ FUN√á√ïES SIMPLIFICADAS PARA TESTE
async function processEntertainmentItemWithAI(message, groupId) {
    if (message.length < 2) return null;
    
    try {
        const category = await callDeepSeekAI(`Categorize: "${message}" - Responda com: filme, s√©rie, desenho, document√°rio, anime, livro, outros.`);
        
        if (!groupData[groupId].items) groupData[groupId].items = [];
        
        groupData[groupId].items.push({
            name: message,
            category: category.toLowerCase(),
            added: new Date().toLocaleDateString('pt-BR')
        });
        
        return `üé¨ "${message}" adicionado como ${category}!`;
        
    } catch (error) {
        return `üé¨ "${message}" adicionado √† lista!`;
    }
}

async function processExpenseItemWithAI(message, groupId) {
    try {
        const aiResponse = await callDeepSeekAI(`Extraia: "${message}" - Formato: descricao|valor|categoria`);
        
        const parts = aiResponse.split('|');
        if (parts.length !== 3) throw new Error('Formato inv√°lido');
        
        const description = parts[0].trim();
        const value = parseFloat(parts[1]);
        const category = parts[2].trim().toLowerCase();
        
        if (!groupData[groupId].items) groupData[groupId].items = [];
        
        groupData[groupId].items.push({
            description: description,
            value: value,
            category: category,
            date: new Date().toLocaleDateString('pt-BR')
        });
        
        return `‚úÖ ${description} - R$ ${value.toFixed(2)} (${category})`;
        
    } catch (error) {
        return "üí∞ Formato: 'descri√ß√£o valor' - Ex: 'uber 15'";
    }
}

async function processShoppingItemWithAI(message, groupId) {
    if (message.toLowerCase().includes('mostrar')) {
        return getShoppingList(groupId);
    }
    
    try {
        const aiResponse = await callDeepSeekAI(`Liste itens: "${message}" - Separe por v√≠rgula.`);
        
        const items = aiResponse.split(',').map(item => item.trim()).filter(item => item);
        
        if (!groupData[groupId].items) groupData[groupId].items = [];
        
        let addedCount = 0;
        items.forEach(item => {
            if (!groupData[groupId].items.find(i => i.toLowerCase() === item.toLowerCase())) {
                groupData[groupId].items.push(item);
                addedCount++;
            }
        });
        
        return `üõí ${addedCount} item(s) adicionado(s)!`;
        
    } catch (error) {
        return "üõí Use: 'item1, item2'";
    }
}

// üîÑ FUN√á√ïES AUXILIARES
async function detectGroupTypeWithAI(message) {
    try {
        const aiResponse = await callDeepSeekAI(`Categorize: "${message}" - Responda: entretenimento, gastos ou compras.`);
        const validTypes = ['entretenimento', 'gastos', 'compras'];
        const detectedType = aiResponse.toLowerCase().trim();
        
        return { 
            type: validTypes.includes(detectedType) ? detectedType : 'compras', 
            items: [] 
        };
    } catch (error) {
        return { type: 'compras', items: [] };
    }
}

function getShoppingList(groupId) {
    const items = groupData[groupId].items;
    if (!items || items.length === 0) return "üõí Lista vazia!";
    
    let response = `üõí LISTA (${items.length} itens):\n\n`;
    items.forEach((item, index) => {
        response += `${index + 1}. ${item}\n`;
    });
    return response;
}

function clearGroupData(groupId) {
    const count = groupData[groupId].items ? groupData[groupId].items.length : 0;
    groupData[groupId].items = [];
    return `üóëÔ∏è ${count} itens removidos.`;
}

function getGroupStatus(groupId, groupType) {
    const items = groupData[groupId].items;
    const count = items ? items.length : 0;
    
    switch(groupType) {
        case 'entretenimento':
            return `üé¨ ${count} itens na lista`;
        case 'gastos':
            const total = items ? items.reduce((sum, item) => sum + item.value, 0) : 0;
            return `üí∞ ${count} gastos - Total: R$ ${total.toFixed(2)}`;
        case 'compras':
            return `üõí ${count} itens na lista`;
        default:
            return `üìä ${count} itens`;
    }
}

function getVexInfo(groupId) {
    const groupType = groupData[groupId] ? groupData[groupId].type : 'n√£o definido';
    const itemsCount = groupData[groupId] && groupData[groupId].items ? groupData[groupId].items.length : 0;
    
    return `ü§ñ *VEX INFO*
‚Ä¢ Tipo: ${groupType}
‚Ä¢ Itens: ${itemsCount}
‚Ä¢ Autorizado: ‚úÖ Sim
‚Ä¢ IA: ${DEEPSEEK_API_KEY ? '‚úÖ' : '‚ùå'}`;
}

function getSenderName(message) {
    return message._data?.notifyName || message.from.split('@')[0];
}

function getVexHelpMessage(groupType) {
    return `ü§ñ *VEX BOT - AJUDA*

*Ativar:* \`/adicionar vex\`
*Remover:* \`/remover vex\`

*Comandos:*
!ajuda - Esta mensagem
!status - Status das listas  
!limpar - Limpa dados
!vexinfo - Info do Vex

*Uso autom√°tico:*
üé¨ Filmes/s√©ries
üí∞ "descri√ß√£o valor"
üõí "itens, separados"`;
}

// INICIALIZAR
client.initialize();

console.log('üîÑ Vex Bot iniciando...');